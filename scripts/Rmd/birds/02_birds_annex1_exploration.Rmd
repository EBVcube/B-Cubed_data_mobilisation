---
title: <span style="color:#005857"> Data exploration of species listed in<br> the Birds Directive Annex I 
subtitle: <span style="color:#47A52A"> Data mobilisation from GBIF to the EBV Data Portal<span>
author: 
  - name: "Lina Estupinan-Suarez,  Miguel Fernandez"
    affiliation: "German Centre for Integrative Biodiversity Research (iDiv)"
    email: lina.estupinans@idiv.de
institute: "**Institute**: German Centre for Integrative Biodiversity Research (iDiv)"
date: "`r Sys.Date()`"
output:
 html_notebook:
    highlight: tango
---
<!-- <img src="C:\gitrepo\B-Cubed_data_mobilization\input\logos\B3_logo_full.png" style='width: 200px; position:absolute; top:0; right:0; padding:10px;'/> -->
<img src="C:\gitrepo\B-Cubed_data_mobilization\input\logos\idiv+b3.png" style='width: 400px; position:absolute; top:0; right:0; padding:10px;'/>
---


### Introduction
In this notebook we explore the occurrence data of species listed in the Annex I of the Birds Directive available in GBIF until June 2024.
To do this, a Birds occurrence cube was previously created using the [occurrence cube software](https://techdocs.gbif.org/en/data-use/data-cubes) developed by GBIF under the [Biodiversity Building Blocks for policy project](https://b-cubed.eu/) (B3)
Details of the data query in GBIF are available at: [doi: ](https://www.gbif.org/occurrence/download/0022320-240626123714530). 
The cube generation script is also part of this repository.

*Note: This series of notebooks is part of the results of the Task 3.3 of the [Biodiversity Building Blocks for policy project](https://b-cubed.eu/) funded by the European Union’s Horizon Europe Research and Innovation Programme (ID No 101059592). Additional notebooks exploring the results and calculating simple metrics are also available at the same repository.*


### Load library and input data
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

```{r}
rm(list=ls())
gc()

# load requiered libraries
library(here)
library(ggplot2)
library(dplyr)
library(lubridate)
```

After loading the necessary libraries, we load the occurrence cube of birds obtained previously through the GBIF API.

```{r}
# Load birds occurrence cube obtained through GBIF
cin <- read.csv(here(paste0("output/datacubes/csv/birds/","0022320-240626123714530.csv")),  sep = "\t")

# Load species taxonomy only with scientific names ‘accepted’ in the GBIF backbone taxonomy
tax <- read.csv(here("input/data/birds/taxonomy/list193birds_directive_annexi_match_gbif.csv"))
```


### Data Analysis
#### Calculate Total Number of Occurrence

```{r}
# Aggregate occurrences at species level
cag <- cin %>%
  group_by(specieskey) %>%
  summarize(totalOcc = sum(occurrences))
```


```{r}
# Rename columns for joining occurence cube with GBIF Backbone taxonomy
colnames(tax)[colnames(tax) == "key"] <- "specieskey"

# Merge data sets and sort in ascending order
xout <- merge(x=cag, y=tax[,c("scientificName", "specieskey", "kingdom", "phylum", "class", "order", "family")], by="specieskey")
xout <- xout[order(xout$totalOcc), ]

write.csv(xout, here("output/summary_data/csv/summary_birds_total_occurrences.csv"))
```

#### Identify birds without Records in GBIF
```{r}
# Find what species have no records in GBIF
noocc <- anti_join(tax, cag, by = "specieskey")
write.csv(noocc, here("output/summary_data/csv/birds_no_occurrences.csv"))
print(noocc[,c("scientificName", "specieskey")])
```
