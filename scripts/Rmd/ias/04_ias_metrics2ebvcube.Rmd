---
title: <span style="color:#005857"> Data Mobilisation from GBIF to the EBV Data Portal for IAS of Union Concern<span>
subtitle: <span style="color:#47A52A"> Notebook 4 - Creation of the EBV NetCDF for <br> the IAS occurrences cube metrics
author: 
  - name: "Lina Estupinan-Suarez, Luise Quoss, Miguel Fernandez"
    affiliation: "German Centre for Integrative Biodiversity Research (iDiv)"
    email: lina.estupinans@idiv.de
institute: "**Institute**: German Centre for Integrative Biodiversity Research (iDiv)"
date: "`r Sys.Date()`"
output:
 html_notebook:
    highlight: tango
---
<img src="C:\gitrepo\B-Cubed_data_mobilization\input\logos\idiv+b3+EU.png" style='width: 400px; position:absolute; top:45px; right:0px; padding:5px;'/>
---


### Introduction
In this notebook we calculate simple metrics for the Annex I of the Birds Directive in Europe.
To do this, a Birds Directive occurrence cube has been created previously (see Notebook 01) using the [occurrence cube software](https://techdocs.gbif.org/en/data-use/data-cubes) developed by GBIF under the [Biodiversity Building Blocks for Policy (B3)](https://b-cubed.eu/) project.
Details of the data query in GBIF are available at [DOI 10.15468/dl.gxk3vh](https://doi.org/10.15468/dl.gxk3vh). 
Here we present five metrics: Total number of occurences, earliest date of occurrence, latest date of occurrences, basis of record of the earliest and latests date of occurrence.

*Note: This series of notebooks is part of the results of the Task 3.3 of the [Biodiversity Building Blocks for Policy](https://b-cubed.eu/) project funded by the European Unionâ€™s Horizon Europe Research and Innovation Programme (ID No 101059592). Additional notebooks exploring the results and calculating simple metrics are also available at the same repository.*

### Load libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

```{r}
rm(list=ls())
gc()

library(ebvcube)
library(here)
library(terra)
```

### Input data
Define paths for reading input data and saving the results.

 
```{r}
# Paths
json <- file.path(here("input/ebvformat/json/ias/ias_metrics_20280815.json")) # EBV metadata as JSON from the EBV Portal
out <- file.path(here("output/datacubes/nc/ias/ias_5_metrics_77sps_.nc")) # path to save EBV NetCDF 

# Tifs
tif_root <- here("output/datacubes/tiff_metrics/ias/")

# Taxonomy file
tax <- file.path(here("input/data/ias/taxonomy/List77IAS_EU_gbif_acceptedUsageKey_ebvcube.csv"))
```

Load all metrics as tiffs. Five in total.
```{r}
# Input rasters: one for each metric
r1 <- rast(here("output/datacubes/tif_metrics/ias/01_ias_total_occurrences.tif")) 
r2 <- rast(here("output/datacubes/tif_metrics/ias/02_ias_earliest_date_records.tif"))
r3 <- rast(here("output/datacubes/tif_metrics/ias/03_ias_latest_date_records.tif"))
r4 <- rast(here("output/datacubes/tif_metrics/ias/04_ias_earliest_date_records_sourceofrecord.tif")) 
r5 <- rast(here("output/datacubes/tif_metrics/ias/05_ias_latest_date_records_sourceofrecord.tif")) 
```

Set the raster settings.
```{r}
# Define raster settings
extent <- c(ext(r1)[1], ext(r1)[2], ext(r1)[3], ext(r1)[4])
res <- res(r1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      fillvalue <- NaN
prec <- 'integer'
epsg <- 3035
sep <- ','
```

Load species taxonomy.

```{r}
# Species key to sort the data
spskey <- names(r1)
spstax <- read.csv(here("input/data/ias/taxonomy/List77IAS_EU_gbif_acceptedUsageKey_ebvcube+key.csv"))

# Check whether the spskey order is the same
spstax$species == spskey
```

### Create EBV NetCDF

Create empty EBV NetCDF.
```{r}
# Create empty file
ebv_create_taxonomy(jsonpath = json,
           outputpath = out,
           taxonomy = tax,
           epsg = epsg,
           extent = extent,
           resolution = res,
           fillvalue = fillvalue,
           prec = prec,
           sep = sep,
           overwrite = T
)
```


```{r}
# Check data
ebv_datacubepaths(out)
ebv_properties(out, metric=1)
```


```{r}
# Add data -----
# Get entity names
entity_names <- ebv_properties(out, verbose=F)@general$entity_names
```


Map input data to the empty NetCDF
```{r}
# for(i in 1:length(spskey)){
# print(i)
# spx <- which(spskey == spstax[["acceptedUsageKey"]][i])
#   ebv_add_data(filepath_nc = out,
#                data = terra::as.matrix(r1[[spx]], wide = T),
#                metric = 1,
#                entity = i,
#                timestep = 1,
#                ignore_RAM = T)

#   ebv_add_data(filepath_nc = out,
#                data = terra::as.matrix(r2[[spx]], wide = T),
#                metric = 2,
#                entity = i,
#                timestep = 1,
#                ignore_RAM = T)

#   ebv_add_data(filepath_nc = out,
#                data = terra::as.matrix(r3[[spx]], wide = T),
#                metric = 3,
#                entity = i,
#                timestep = 1,
#                ignore_RAM = T)

#   ebv_add_data(filepath_nc = out,
#                data = terra::as.matrix(r4[[spx]], wide = T),
#                metric = 4,
#                entity = i,
#                timestep = 1,
#                ignore_RAM = T)
              
#   ebv_add_data(filepath_nc = out,
#                data = terra::as.matrix(r5[[spx]], wide = T),
#                metric = 5,
#                entity = i,
#                timestep = 1,
#                ignore_RAM = T)
# }
```