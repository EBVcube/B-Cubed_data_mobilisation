---
title: <span style="color:#005857"> Data exploration of <br> the IAS occurrences cube
subtitle: <span style="color:#47A52A"> Data mobilisation from GBIF to the EBV Data Portal<span>
author: 
  - name: "Lina Estupinan-Suarez, Emmanuel Oceguera, Miguel Fernandez"
    affiliation: "German Centre for Integrative Biodiversity Research (iDiv)"
    email: lina.estupinans@idiv.de
institute: "**Institute**: German Centre for Integrative Biodiversity Research (iDiv)"
date: "`r Sys.Date()`"
output:
 html_notebook:
    highlight: tango
---
<!-- <img src="C:\gitrepo\B-Cubed_data_mobilization\input\logos\B3_logo_full.png" style='width: 200px; position:absolute; top:0; right:0; padding:10px;'/> -->
<img src="C:\gitrepo\B-Cubed_data_mobilization\input\logos\idiv+b3.png" style='width: 400px; position:absolute; top:0; right:0; padding:10px;'/>
---


### Introduction
In this notebook we explore the occurrence data of invasive alien species (IAS) of union concern available in GBIF until June 2024.
To do this, an IAS occurrence cube was previously created using the [occurrence cube software](https://techdocs.gbif.org/en/data-use/data-cubes) developed by GBIF under the [Biodiversity Building Blocks for policy project](https://b-cubed.eu/) (B3)
Details of the data query in GBIF are available at: [doi: 10.15468/dl.x4a25s](https://www.gbif.org/occurrence/download/0081452-240506114902167). 
The cube generation script is also part of this repository.

*Note: This series of notebooks is part of the results of the Task 3.3 of the [Biodiversity Building Blocks for policy project](https://b-cubed.eu/) funded by the European Union’s Horizon Europe Research and Innovation Programme (ID No 101059592). Additional notebooks exploring the results and calculating simple metrics are also available at the same repository.*


### Load library and input data
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

```{r}
rm(list=ls())
gc()

# load requiered libraries
library(here)
library(ggplot2)
library(dplyr)
library(lubridate)
```

After loading the necessary libraries, we load the occurrence cube of IAS obtained previously through the GBIF API.

```{r}
# Load IAS occurrence cube obtained through GBIF
# cin <- read.csv(here(paste0("output/datacubes/csv/ias/","0077925-240506114902167.csv")),  sep = "\t")

# File name from the JSON query
occcube <- "0077925-240506114902167"

# Load occurrence cube using b3gbi
cin <- process_cube(here(paste0("output/datacubes/csv/ias/", occcube,".csv")))

# Load species taxonomy only with scientific names ‘accepted’ in the GBIF backbone taxonomy
tax <- read.csv(here("input/data/ias/taxonomy/List87IAS_EU_match_gbif_allaccepted.csv"))
```


### Data Analysis
#### Calculate Total Number of Occurrence

```{r}
cdata <- cin[["data"]]
# rename columns
colnames(cdata)[colnames(cdata) == "order"] <- "order_"
colnames(cdata)[colnames(cdata) == "taxonKey"] <- "acceptedUsageKey"

# Aggregate occurrences at species level
cag <- cdata %>%
  group_by(acceptedUsageKey) %>%
  summarize(totalOcc = sum(obs))

 # Sort in ascending order
cag <- cag[order(cag$totalOcc), ] 
```

```{r}
# Rename columns for joining datasets
# colnames(tax)[colnames(tax) == "key"] <- "acceptedUsageKey"
tax[,c("accpetedUsageKey")] <- tax[,c("key")]

# Rename columns for joining occurence cube with GBIF Backbone taxonomy
xout <- merge(x=cag, y=tax[,c("scientificName", "acceptedUsageKey", "kingdom", "phylum", "class", "order", "family")], by="acceptedUsageKey")
xout <- xout[order(xout$totalOcc), ]

write.csv(xout, here("output/summary_data/csv/summary_ias_totalOccurrences.csv"))
```

#### Identify IAS without Records in GBIF
```{r}
# Find what species have no records in GBIF
noocc <- anti_join(tax, cag, by = "acceptedUsageKey")
write.csv(noocc, here("output/summary_data/csv/ias_noOccurrences.csv"))
print(noocc)
```


### Data Exploration

We will explore data available since 1900. To do this, first we split the 'yearMonth' column into 'year' and 'month'.


```{r}
# Convert date from character to numeric
todates <- as.data.frame(str_split(cdata$yearMonth, "-", simplify = TRUE))
colnames(todates) <- c("year", "month")

# Add year and month columns separate to the initial data
cdata$year <- todates$year
cdata$month <- todates$month

# Filter data starting from 1950
cdata2 <- cdata %>%
  filter(year > 1950)

# Group data by year
cag_year <- cdata2 %>%
    group_by(year) %>%
  summarize(totalOcc = sum(obs))

# Group data by month
cag_month <- cdata %>%
    group_by(month) %>%
  summarize(totalOcc = sum(obs))

```
